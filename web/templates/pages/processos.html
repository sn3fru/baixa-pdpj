{% extends "base.html" %}
{% block title %}Processos{% endblock %}

{% block content %}
<div x-data="processosPage()" x-init="init()">
  <div class="flex items-center justify-between mb-6">
    <div>
      <h2 class="text-2xl font-bold">Processos</h2>
      <p class="text-gray-400 text-sm mt-1">Resultado consolidado do S2 (todos os processos deduplicados)</p>
    </div>
    <div class="flex gap-2">
      <button @click="exportXlsx()" class="text-xs px-3 py-1.5 bg-emerald-700 text-white rounded hover:bg-emerald-600 transition">Exportar Excel</button>
      <button @click="exportCsv()" class="text-xs px-3 py-1.5 bg-gray-700 text-gray-200 rounded hover:bg-gray-600 transition">Exportar CSV</button>
      <button @click="downloadOriginal()" x-show="originalFile"
              class="text-xs px-3 py-1.5 bg-gray-800 text-gray-300 rounded hover:bg-gray-700 transition">Baixar Original</button>
    </div>
  </div>

  <!-- Stats rapidas -->
  <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6">
    <div class="bg-gray-900 rounded border border-gray-800 p-3 text-center">
      <p class="text-xs text-gray-500">Total</p>
      <p class="text-xl font-bold text-blue-400" x-text="stats.total"></p>
    </div>
    <div class="bg-gray-900 rounded border border-gray-800 p-3 text-center">
      <p class="text-xs text-gray-500">Filtrados</p>
      <p class="text-xl font-bold text-cyan-400" x-text="stats.filtered"></p>
    </div>
    <div class="bg-gray-900 rounded border border-gray-800 p-3 text-center">
      <p class="text-xs text-gray-500">Pagina</p>
      <p class="text-xl font-bold text-gray-300" x-text="stats.page + '/' + stats.lastPage"></p>
    </div>
    <div class="bg-gray-900 rounded border border-gray-800 p-3 text-center">
      <p class="text-xs text-gray-500">Por Pagina</p>
      <select x-model.number="pageSize" @change="reload()"
              class="bg-gray-800 text-gray-300 text-sm border border-gray-700 rounded px-2 py-0.5 mt-0.5">
        <option value="25">25</option>
        <option value="50">50</option>
        <option value="100">100</option>
        <option value="200">200</option>
      </select>
    </div>
    <div class="bg-gray-900 rounded border border-gray-800 p-3 text-center">
      <p class="text-xs text-gray-500">Arquivo</p>
      <p class="text-xs text-gray-400 mt-1 truncate" x-text="originalFile || '-'"></p>
    </div>
  </div>

  <!-- Loading -->
  <div x-show="loading" class="flex items-center gap-2 mb-4 text-gray-500 text-sm">
    <div class="animate-spin h-4 w-4 border-2 border-blue-400 border-t-transparent rounded-full"></div>
    Carregando dados...
  </div>

  <!-- Error -->
  <div x-show="errorMsg" class="bg-red-900/30 border border-red-800/50 rounded-lg p-4 mb-4 text-sm text-red-300"
       x-text="errorMsg"></div>

  <!-- Table -->
  <div class="bg-gray-900 rounded-lg border border-gray-800 p-5">
    <div id="processos-table"></div>
    <p x-show="!loading && stats.total === 0" class="text-gray-600 text-sm">
      Nenhum processo encontrado. Execute o pipeline S2 primeiro.
    </p>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function processosPage() {
  return {
    loading: true,
    errorMsg: '',
    originalFile: null,
    pageSize: 50,
    table: null,
    columns: [],
    stats: { total: 0, filtered: 0, page: 1, lastPage: 1 },
    _filters: {},
    _sort: null,
    _sortDir: 'asc',
    _debounceTimer: null,

    async init() {
      // 1. Busca metadados (colunas, arquivo, total) â€” leve, sem dados
      try {
        const res = await fetch('/api/processos/meta');
        const meta = await res.json();
        this.originalFile = meta.file;
        this.stats.total = meta.total;
        this.columns = meta.columns || [];

        if (!meta.columns || !meta.columns.length) {
          this.loading = false;
          return;
        }

        // 2. Monta Tabulator com paginacao remota
        this._buildTable(meta.columns);

      } catch(e) {
        this.errorMsg = 'Erro ao carregar: ' + e.message;
        this.loading = false;
      }
    },

    _buildTable(colNames) {
      const self = this;

      const cols = colNames.map(c => {
        const col = {
          title: c, field: c, headerFilter: "input",
          headerFilterLiveFilter: false, // Filtra ao apertar Enter, nao a cada tecla
          sorter: "string", minWidth: 100,
        };
        if (['Valor Causa', 'Valor Causa Corrigido'].includes(c)) {
          col.sorter = "number";
          col.hozAlign = "right";
          col.formatter = function(cell) {
            const v = parseFloat(cell.getValue());
            if (isNaN(v)) return '-';
            return v.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
          };
        }
        if (c.startsWith('Flag ')) {
          col.width = 80;
          col.hozAlign = "center";
          col.formatter = function(cell) {
            return cell.getValue() === '1'
              ? '<span class="text-emerald-400 font-bold">S</span>'
              : '<span class="text-gray-700">-</span>';
          };
        }
        if (c === 'Processo') { col.frozen = true; col.width = 220; }
        return col;
      });

      this.table = new Tabulator('#processos-table', {
        columns: cols,
        layout: "fitDataFill",
        height: "600px",
        placeholder: "Nenhum dado",
        // --- Paginacao remota ---
        pagination: true,
        paginationMode: "remote",
        paginationSize: this.pageSize,
        paginationButtonCount: 7,
        // --- Sort e Filter remotos ---
        sortMode: "remote",
        filterMode: "remote",
        // --- Request customizado (controle total) ---
        ajaxURL: "/api/processos/filter",
        ajaxRequestFunc: function(url, config, params) {
          return self._fetchData(url, params);
        },
      });

      this.table.on("dataLoading", () => { self.loading = true; });
      this.table.on("dataLoaded", () => { self.loading = false; });
    },

    _fetchData(url, params) {
      const self = this;
      const p = new URLSearchParams();
      p.set('page', params.page || 1);
      p.set('size', params.size || this.pageSize);

      // Sort - Tabulator v6 pode enviar como 'sort' ou 'sorters'
      const sorters = params.sorters || params.sort || [];
      if (sorters.length > 0) {
        p.set('sort', sorters[0].field || sorters[0].column);
        p.set('dir', sorters[0].dir || 'asc');
      }

      // Filters
      const filterArr = params.filter || params.filters || [];
      const filters = {};
      for (const f of filterArr) {
        if (f.value) filters[f.field] = f.value;
      }
      if (Object.keys(filters).length > 0) {
        p.set('q', JSON.stringify(filters));
      }

      return fetch('/api/processos/filter?' + p.toString())
        .then(r => r.json())
        .then(response => {
          self.loading = false;
          self.stats.filtered = response.total_filtered ?? response.total ?? 0;
          self.stats.total = response.total ?? 0;
          self.stats.lastPage = response.last_page ?? 1;
          self.stats.page = parseInt(params.page) || 1;
          return response;
        });
    },

    reload() {
      if (this.table) {
        this.table.setPageSize(this.pageSize);
      }
    },

    exportXlsx() {
      if (this.table) this.table.download("xlsx", "processos.xlsx", {sheetName: "Processos"});
    },
    exportCsv() {
      if (this.table) this.table.download("csv", "processos.csv");
    },
    downloadOriginal() {
      if (this.originalFile) window.open('/api/arquivos/download?path=' + encodeURIComponent(this.originalFile));
    },
  };
}
</script>
{% endblock %}

{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<h2 class="text-2xl font-bold mb-6">Dashboard</h2>

<!-- Aviso Heroku: filesystem efemero -->
<div x-data="{ show: true, hasData: false }" x-init="fetch('/api/download-zip/info').then(r=>r.json()).then(d => hasData = d.exists)" x-show="show"
     class="bg-yellow-900/20 border border-yellow-700/30 rounded-lg p-4 mb-6 flex items-start gap-3">
  <svg class="w-5 h-5 text-yellow-400 shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
  </svg>
  <div class="flex-1">
    <p class="text-sm text-yellow-300 font-semibold">Armazenamento temporario (Heroku)</p>
    <p class="text-xs text-gray-400 mt-1">
      Os dados baixados ficam apenas na memoria do servidor. Quando o dyno reiniciar (deploy, hibernacao, ou restart),
      <strong class="text-yellow-300">todos os resultados serao perdidos</strong>.
      Apos executar o pipeline, faca o download do ZIP com todos os dados.
    </p>
    <div class="flex items-center gap-3 mt-2">
      <a x-show="hasData" href="/api/download-zip"
         class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-emerald-700 hover:bg-emerald-600 text-white text-xs rounded transition font-medium">
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
        Baixar ZIP agora
      </a>
      <button @click="show = false" class="text-xs text-gray-500 hover:text-gray-400 transition">Fechar</button>
    </div>
  </div>
</div>

<!-- KPI Cards (auto-refresh via JS) -->
<div id="stats-container">
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
    <div class="bg-gray-900 rounded-lg border border-gray-800 p-4">
      <p class="text-xs text-gray-500 uppercase tracking-wider">Individuos</p>
      <p class="text-3xl font-bold text-blue-400 mt-1">-</p>
    </div>
    <div class="bg-gray-900 rounded-lg border border-gray-800 p-4">
      <p class="text-xs text-gray-500 uppercase tracking-wider">Processos</p>
      <p class="text-3xl font-bold text-emerald-400 mt-1">-</p>
    </div>
    <div class="bg-gray-900 rounded-lg border border-gray-800 p-4">
      <p class="text-xs text-gray-500 uppercase tracking-wider">Ativos</p>
      <p class="text-3xl font-bold text-yellow-400 mt-1">-</p>
    </div>
    <div class="bg-gray-900 rounded-lg border border-gray-800 p-4">
      <p class="text-xs text-gray-500 uppercase tracking-wider">Devedores</p>
      <p class="text-3xl font-bold text-purple-400 mt-1">-</p>
    </div>
  </div>
</div>

<!-- BI Charts -->
<div id="bi-charts-section">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">Analise dos Processos</h3>
    <div id="bi-loading" class="flex items-center gap-2 text-xs text-gray-500">
      <div class="animate-spin h-3 w-3 border border-gray-500 border-t-transparent rounded-full"></div>
      Carregando graficos...
    </div>
  </div>
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Tribunal -->
    <div class="bg-gray-900 rounded-lg border border-gray-800 p-5">
      <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Por Tribunal</h4>
      <div id="dash-chart-tribunal" style="height:260px"></div>
    </div>
    <!-- Distribuicao de Valor -->
    <div class="bg-gray-900 rounded-lg border border-gray-800 p-5">
      <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Distribuicao de Valor</h4>
      <div id="dash-chart-valor" style="height:260px"></div>
    </div>
    <!-- Idade dos Processos -->
    <div class="bg-gray-900 rounded-lg border border-gray-800 p-5">
      <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Idade dos Processos</h4>
      <div id="dash-chart-idade" style="height:260px"></div>
    </div>
    <!-- Classe -->
    <div class="bg-gray-900 rounded-lg border border-gray-800 p-5">
      <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Classe Processual</h4>
      <div id="dash-chart-classe" style="height:260px"></div>
    </div>
    <!-- Status + Origens (lado a lado) -->
    <div class="bg-gray-900 rounded-lg border border-gray-800 p-5">
      <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Status dos Processos</h4>
      <div id="dash-chart-status" style="height:260px"></div>
    </div>
    <div class="bg-gray-900 rounded-lg border border-gray-800 p-5">
      <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Origens de Busca</h4>
      <div id="dash-chart-origens" style="height:260px"></div>
    </div>
  </div>
</div>

<!-- Historico de execucoes -->
<div class="bg-gray-900 rounded-lg border border-gray-800 p-5">
  <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4">Ultimas Execucoes</h3>
  {% if history %}
  <table class="w-full text-sm">
    <thead>
      <tr class="text-gray-500 border-b border-gray-800">
        <th class="text-left py-2 px-3">ID</th>
        <th class="text-left py-2 px-3">Steps</th>
        <th class="text-left py-2 px-3">Inicio</th>
        <th class="text-left py-2 px-3">Status</th>
      </tr>
    </thead>
    <tbody>
      {% for run in history %}
      <tr class="border-b border-gray-800/50 hover:bg-gray-800/50">
        <td class="py-2 px-3 font-mono text-xs">{{ run.id }}</td>
        <td class="py-2 px-3">{{ run.steps | join(", ") }}</td>
        <td class="py-2 px-3 text-gray-400">{{ run.started[:19] }}</td>
        <td class="py-2 px-3">
          {% if run.status == "completed" %}
            <span class="px-2 py-0.5 rounded-full bg-emerald-900/50 text-emerald-400 text-xs">OK</span>
          {% elif run.status == "error" %}
            <span class="px-2 py-0.5 rounded-full bg-red-900/50 text-red-400 text-xs">Erro</span>
          {% else %}
            <span class="px-2 py-0.5 rounded-full bg-blue-900/50 text-blue-400 text-xs">{{ run.status }}</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p class="text-gray-600 text-sm">Nenhuma execucao registrada nesta sessao.</p>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
const _dashCharts = {};

// ========== KPI Cards ==========
async function loadKPIs() {
  try {
    const res = await fetch('/api/stats');
    const s = await res.json();
    const c = document.getElementById('stats-container');
    if (!c) return;

    let homAlert = '';
    if (s.homonimos_pendentes > 0) {
      homAlert = `<div class="col-span-2 md:col-span-4 bg-amber-900/20 border border-amber-700/30 rounded-lg p-3 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="w-2 h-2 rounded-full bg-amber-400 animate-pulse"></span>
          <span class="text-sm text-amber-300 font-medium">${s.homonimos_pendentes} homonimo(s) pendente(s)</span>
          <span class="text-xs text-gray-500">â€” todos foram baixados, refine selecionando os documentos corretos</span>
        </div>
        <a href="/homonimos" class="text-xs px-3 py-1.5 bg-amber-700 hover:bg-amber-600 text-white rounded transition font-medium">Resolver</a>
      </div>`;
    }
    c.innerHTML = `
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        ${homAlert}
        ${_kpi('Individuos', s.individuos, 'blue')}
        ${_kpi('Processos', s.processos, 'emerald')}
        ${_kpi('Ativos', s.ativos, 'yellow')}
        ${_kpi('Extintos', s.extintos, 'red')}
        ${_kpi('Exec. Fiscal', s.exec_fiscal, 'amber')}
        ${_kpi('Devedores', s.devedores, 'purple')}
        ${_kpi('Por Documento', (s.origens||{}).por_documento, 'cyan')}
        ${_kpi('Por Nome', (s.origens||{}).por_nome, 'pink')}
      </div>`;
  } catch(e) { console.warn('KPI load:', e); }
}

function _kpi(label, value, color) {
  return `<div class="bg-gray-900 rounded-lg border border-gray-800 p-4">
    <p class="text-xs text-gray-500 uppercase tracking-wider">${label}</p>
    <p class="text-3xl font-bold text-${color}-400 mt-1">${(value||0).toLocaleString('pt-BR')}</p>
  </div>`;
}

// ========== BI Charts ==========
async function loadBICharts() {
  const loading = document.getElementById('bi-loading');
  try {
    const res = await fetch('/api/stats/charts');
    const data = await res.json();

    // Check if there's any data at all
    const hasData = data.tribunal?.length || data.valor_distribuicao?.length || data.idade_distribuicao?.length;
    if (!hasData) {
      if (loading) loading.innerHTML = '<span class="text-xs text-gray-600">Sem dados. Execute o pipeline primeiro.</span>';
      return;
    }
    if (loading) loading.style.display = 'none';

    _hBar('dash-chart-tribunal', data.tribunal, '#60A5FA');
    _vBar('dash-chart-valor', data.valor_distribuicao, 'faixa', 'count', '#F59E0B');
    _vBar('dash-chart-idade', data.idade_distribuicao, 'faixa', 'count', '#A78BFA');
    _hBar('dash-chart-classe', data.classe, '#34D399');
    _donut('dash-chart-status', data.status, ['#34D399', '#EF4444', '#6B7280']);
    _donut('dash-chart-origens', data.origens, ['#60A5FA', '#F59E0B', '#A78BFA']);
  } catch(e) {
    console.warn('Charts load:', e);
    if (loading) loading.innerHTML = '<span class="text-xs text-red-400">Erro ao carregar graficos</span>';
  }
}

// ========== Chart Helpers ==========
const _darkOpts = {
  textStyle: { color: '#9CA3AF', fontSize: 11 },
};

function _hBar(id, items, color) {
  const el = document.getElementById(id);
  if (!el) return;
  if (!items || !items.length) { el.innerHTML = '<p class="text-xs text-gray-600 text-center pt-16">Sem dados</p>'; return; }
  const chart = _getChart(id, el);
  const names = items.map(i => i.name).reverse();
  const values = items.map(i => i.value).reverse();
  chart.setOption({
    ..._darkOpts, backgroundColor: 'transparent',
    grid: { left: '3%', right: '15%', top: 8, bottom: 8, containLabel: true },
    xAxis: { type: 'value', show: false },
    yAxis: { type: 'category', data: names,
      axisLabel: { color: '#9CA3AF', fontSize: 10, width: 140, overflow: 'truncate' },
      axisLine: { show: false }, axisTick: { show: false },
    },
    series: [{ type: 'bar', data: values, barMaxWidth: 20,
      itemStyle: { color: color, borderRadius: [0,4,4,0] },
      label: { show: true, position: 'right', color: '#D1D5DB', fontSize: 10,
        formatter: (p) => p.value.toLocaleString('pt-BR') },
    }],
    tooltip: { trigger: 'axis', backgroundColor: '#1F2937', borderColor: '#374151',
      textStyle: { color: '#E5E7EB', fontSize: 11 } },
  });
}

function _vBar(id, items, faixaKey, countKey, color) {
  const el = document.getElementById(id);
  if (!el) return;
  if (!items || !items.length) { el.innerHTML = '<p class="text-xs text-gray-600 text-center pt-16">Sem dados</p>'; return; }
  const chart = _getChart(id, el);
  chart.setOption({
    ..._darkOpts, backgroundColor: 'transparent',
    grid: { left: '5%', right: '3%', top: 15, bottom: '18%', containLabel: true },
    xAxis: { type: 'category', data: items.map(i => i[faixaKey]),
      axisLabel: { color: '#9CA3AF', fontSize: 9, rotate: 25 },
      axisLine: { lineStyle: { color: '#374151' }}, axisTick: { show: false },
    },
    yAxis: { type: 'value', splitLine: { lineStyle: { color: '#1F2937' }},
      axisLabel: { color: '#6B7280', fontSize: 9 },
    },
    series: [{ type: 'bar', data: items.map(i => i[countKey]), barMaxWidth: 32,
      itemStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1,[
        {offset: 0, color: color}, {offset: 1, color: color + '44'}
      ]), borderRadius: [4,4,0,0] },
      label: { show: true, position: 'top', color: '#D1D5DB', fontSize: 9 },
    }],
    tooltip: { trigger: 'axis', backgroundColor: '#1F2937', borderColor: '#374151',
      textStyle: { color: '#E5E7EB', fontSize: 11 } },
  });
}

function _donut(id, items, colors) {
  const el = document.getElementById(id);
  if (!el) return;
  if (!items || !items.length) { el.innerHTML = '<p class="text-xs text-gray-600 text-center pt-16">Sem dados</p>'; return; }
  const chart = _getChart(id, el);
  chart.setOption({
    ..._darkOpts, backgroundColor: 'transparent',
    series: [{
      type: 'pie', radius: ['40%', '72%'], center: ['50%', '52%'],
      data: items.map((it, idx) => ({
        name: it.name, value: it.value,
        itemStyle: { color: colors[idx % colors.length] },
      })),
      label: { color: '#D1D5DB', fontSize: 11,
        formatter: '{b}\n{c}' },
      emphasis: { itemStyle: { shadowBlur: 10, shadowColor: 'rgba(0,0,0,0.3)' }},
    }],
    tooltip: { backgroundColor: '#1F2937', borderColor: '#374151',
      textStyle: { color: '#E5E7EB', fontSize: 11 } },
  });
}

function _getChart(id, el) {
  if (_dashCharts[id]) {
    return _dashCharts[id];
  }
  const chart = echarts.init(el, null, {renderer: 'canvas'});
  _dashCharts[id] = chart;
  return chart;
}

// ========== Init ==========
loadKPIs();
loadBICharts();

// Auto-refresh KPIs a cada 15s
setInterval(loadKPIs, 15000);
// Refresh charts a cada 60s (mais pesado)
setInterval(loadBICharts, 60000);

// Resize
window.addEventListener('resize', () => {
  Object.values(_dashCharts).forEach(c => { try { c.resize(); } catch(e){} });
});
</script>
{% endblock %}
